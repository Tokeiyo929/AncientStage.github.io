<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>乐平古戏台营造技艺与建构认知虚拟仿真实验</title>
  <link rel="shortcut icon" href="TemplateData/favicon.ico">
  <link rel="stylesheet" href="TemplateData/style.css">
  <script src="TemplateData/jquery-3.6.0.min.js"></script>
  <script src="TemplateData/UnityProgress.js"></script>
  <script src="Build/UnityLoader.js"></script>
  <script>
    var gameInstance = UnityLoader.instantiate("gameContainer", "Build/乐平戏台打包文件.json", { onProgress: UnityProgress });
    function OnAppReady(){
      console.log("OnAppReady");
      getUserInfo();
    }
    function downloadPDF() {
    var pdfPath = 'StreamingAssets/ZhiDaoShu.pdf';

    var xhr = new XMLHttpRequest();
    xhr.open('GET', pdfPath, true);
    xhr.responseType = 'blob';

    xhr.onload = function () {
        var blob = new Blob([xhr.response], { type: 'application/pdf' });

        var link = document.createElement('a');
        link.href = window.URL.createObjectURL(blob);
        link.download = 'downloaded_pdf.pdf';

        // 模拟用户点击<a>元素来触发下载
        link.click();
    };

    xhr.send();
  }
  </script>
</head>

<body style="width:100%;height:100%;">
  <div class="webgl-content" id="wegmain" style="width: 100%;height:100%;">
    <div id="gameContainer" style="width: 100%; height: 100%"></div>
    <div class="web-content" id="webcontent">
      <div class="title">乐平古戏台营造技艺与建构认知虚拟仿真实验</div>
      <div class="tnext"></div>

      <div class="tfoot">推荐使用Chrome浏览器进行浏览</div>
    </div>
    <div class="web-content" id="notsupport" style="display:none">
      <div class="tnext" style="margin-top:200px;color:#000;font-size:30px;">
        检测到您所使用的浏览器不支持虚拟现实3D显示<br>请下载安装使用Chrome浏览器重新访问</div>
      <br>
      <button onclick="goDown()"
        style="cursor:pointer;color:#fff;font-size:30px;width:278px;height:65px;right:0;background-image:url('./TemplateData/but-bg.png');background-color:rgba(0,0,0,0);position:absolute;left:50%;margin-left:-139px;">立即下载</button>
    </div>
  </div>
  <script type="text/javascript">
	function getQueryVariable(variable) {
        var query = window.location.search.substring(1);
        if(window.parent!==undefined){
          query = window.parent.location.search.substring(1);
        }
        var vars = query.split("&");
        for (var i = 0; i < vars.length; i++) {
            var pair = vars[i].split("=");
            if (pair[0] == variable) {
                return vars[i].substring(variable.length + 1);
            }
        }
        return (false);
    }
    function goDown() {
      window.location.href = "http://www.google.cn/intl/zh-CN/chrome/browser/desktop/index.html";
    }

    function changeFrameHeight() {
      document.getElementById("wegmain").style.height = "100%";
      document.getElementById("gameContainer").style.width = "100%";
      document.getElementById("gameContainer").style.height = "100%";
      document.getElementById("#canvas").style.width = "100%";
      document.getElementById("#canvas").style.height = "100%";
      document.getElementById("gameContainer").style.left = 0 + "px";
    }
    window.onresize = function () { changeFrameHeight(); }

    function getUserInfo() {
      $.ajax({
        type: 'GET',
        url: '/member/memberinfo',
        headers: {
          'APP-Auth-Token': localStorage.getItem('APP-Auth-Token')
        },
        success: function (userInfo) {
          // 根据需要处理用户信息
          console.log(userInfo);
          // 将用户信息发送给Unity
          sendUserInfoToUnity(userInfo);
        },
        error: function (ex) {
          console.log(ex);
        }
      });
    }
    
    // 将用户信息发送给Unity的函数
    function sendUserInfoToUnity(userInfo) {
      // 存在名为 "VlabTool" 的Unity对象，调用名为 "ReceiveUserInfo" 的方法，并传递用户信息参数
      gameInstance.SendMessage("VlabTool", "ReceiveUserInfo", JSON.stringify(userInfo));
    }

    window.onload = function () {
      changeFrameHeight();
    }

    if (UnityLoader.SystemInfo.hasWebGL == 0 || ["Firefox", "Chrome", "Safari"].indexOf(UnityLoader.SystemInfo.browser) == -1) {
      document.getElementById("webcontent").style.display = "none";
      document.getElementById("gameContainer").style.display = "none";
      document.getElementById("notsupport").style.display = "block";
    }
	
	function dataURLtoFile(dataurl, filename, mime) {//将base64转换为文件
        var arr = dataurl,
            bstr = atob(arr), n = bstr.length, u8arr = new Uint8Array(n);
        while(n--){
            u8arr[n] = bstr.charCodeAt(n);
        }
        return new File([u8arr], filename, {type:mime});
	}
	
	function UploadFile(base64,name,mime, scoreid) {
		var pic = dataURLtoFile(base64,name,mime);
        var file = new FormData();
        file.append('uploadFile', pic, name);

        $.ajax({
          type: 'post',
          url: '../../member/upload/o_upload',
          dataType: 'json',
          data: file,
          cache: false,
          contentType: false,
          processData: false,
          async: false,
          headers: {
            'APP-Auth-Token': localStorage.getItem('APP-Auth-Token')
          },
          success: function (res) {
            console.log(res)
            if (res.code == 200) {
              let data = res.data
              var resourceId = data.resourceId
              //var id = data.id
              console.log(resourceId)
			  gameInstance.SendMessage("VlabTool", "UploadCallBack", resourceId);
			   var data2 = {
				"id": scoreid,
				"resourceId": resourceId
			  };
			  
			  $.ajax({
				url: '../../member/personal-score/callbackUrl',
				type: "POST",
				data: JSON.stringify(data2),
				contentType: "application/json",
				headers: {
				  'APP-Auth-Token': localStorage.getItem('APP-Auth-Token')
				},
				success: function (res) {
					console.log(res);
				},
				error: function (ex) {
					console.log(ex);
				}
			  });
            } else {
              //alert(res.message || '服务器错误')
			  gameInstance.SendMessage("VlabTool", "UploadCallBackError", JSON.stringify(res));
            }
          }
        });
	}

    function CommitScore(score, detail, timeLength,udata ) {
	
      var data = {
        "experimentName": "乐平古戏台营造技艺与建构认知虚拟仿真实验",
        "machineScore": score,
        "detailsInfomation": detail,
        "examTime": timeLength,
        "uploadData": JSON.parse(udata)
      };
	  
      console.log(data);
      $.ajax({
        url: '../../admin/score/insertScore',
        type: "PUT",
        data: JSON.stringify(data),
        contentType: "application/json",
        headers: {
          'APP-Auth-Token': localStorage.getItem('APP-Auth-Token')
        },
        success: function (res) {
			gameInstance.SendMessage("VlabTool", "CommitCallBack", JSON.stringify(res));
        },
        error: function (ex) {
			console.log(ex);
			gameInstance.SendMessage("VlabTool", "CommitCallBack", ex.responseText);
        }
      });
    }
  </script>
</body>

</html>